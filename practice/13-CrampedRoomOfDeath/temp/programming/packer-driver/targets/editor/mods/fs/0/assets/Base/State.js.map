{"version":3,"sources":["file:///Users/lindanian/projects/git/cocos-creator-projects/practice/13-CrampedRoomOfDeath/assets/Base/State.ts"],"names":["State","AnimationClip","Sprite","animation","ResourceManager","sortSpriteFrame","ANIMATION_SPEED","constructor","fsm","path","wrapMode","WrapMode","Normal","speed","events","init","promise","Instance","loadDir","waitingList","push","spriteFrames","animationClip","track","ObjectTrack","TrackPath","toComponent","toProperty","frames","map","item","index","channel","curve","assignSorted","addTrack","name","duration","length","event","updateEventDatas","run","animationComponent","defaultClip","play"],"mappings":";;;kGAWqBA,K;;;;;;;;;;;;;;;;;;;;;;;AAPbC,MAAAA,a,OAAAA,a;AAAeC,MAAAA,M,OAAAA,M;AAAQC,MAAAA,S,OAAAA,S;;AACxBC,MAAAA,e;;AAECC,MAAAA,e,iBAAAA,e;;;;;;;iCAEKC,e,GAAkB,IAAE,C;;yBAEZN,K,GAAN,MAAMA,KAAN,CAAY;AACvBO,QAAAA,WAAW,CACCC,GADD,EAECC,IAFD,EAGCC,QAAgC,GAAGT,aAAa,CAACU,QAAd,CAAuBC,MAH3D,EAICC,KAAa,GAAGP,eAJjB,EAKCQ,MAAa,GAAG,EALjB,EAMV;AAAA;;AAAA,eALWN,GAKX,GALWA,GAKX;AAAA,eAJWC,IAIX,GAJWA,IAIX;AAAA,eAHWC,QAGX,GAHWA,QAGX;AAAA,eAFWG,KAEX,GAFWA,KAEX;AAAA,eADWC,MACX,GADWA,MACX;AACG,eAAKC,IAAL;AACH;;AAGS,cAAJA,IAAI,GAAE;AACR,gBAAMC,OAAO,GAAG;AAAA;AAAA,kDAAgBC,QAAhB,CAAyBC,OAAzB,CAAiC,KAAKT,IAAtC,CAAhB;AACA,eAAKD,GAAL,CAASW,WAAT,CAAqBC,IAArB,CAA0BJ,OAA1B;AACA,gBAAMK,YAAY,GAAG,MAAML,OAA3B;AACA,eAAKM,aAAL,GAAqB,IAAIrB,aAAJ,EAArB;AAEA,gBAAMsB,KAAK,GAAG,IAAIpB,SAAS,CAACqB,WAAd,EAAd,CANQ,CAMmC;;AAC3CD,UAAAA,KAAK,CAACd,IAAN,GAAa,IAAIN,SAAS,CAACsB,SAAd,GAA0BC,WAA1B,CAAsCxB,MAAtC,EAA8CyB,UAA9C,CAAyD,aAAzD,CAAb,CAPQ,CAO8E;;AACtF,gBAAMC,MAAmC,GAAG;AAAA;AAAA,kDAAgBP,YAAhB,EAA8BQ,GAA9B,CAAkC,CAACC,IAAD,EAAOC,KAAP,KAAgB,CAAC,KAAKlB,KAAL,GAAakB,KAAd,EAAqBD,IAArB,CAAlD,CAA5C,CARQ,CASR;;AACAP,UAAAA,KAAK,CAACS,OAAN,CAAcC,KAAd,CAAoBC,YAApB,CAAiCN,MAAjC,EAVQ,CAWR;;AACA,eAAKN,aAAL,CAAmBa,QAAnB,CAA4BZ,KAA5B;AACA,eAAKD,aAAL,CAAmBc,IAAnB,GAA0B,KAAK3B,IAA/B;AACA,eAAKa,aAAL,CAAmBe,QAAnB,GAA8BT,MAAM,CAACU,MAAP,GAAgB,KAAKzB,KAAnD,CAdQ,CAckD;;AAC1D,eAAKS,aAAL,CAAmBZ,QAAnB,GAA8B,KAAKA,QAAnC,CAfQ,CAiBR;;AACA,eAAK,MAAM6B,KAAX,IAAoB,KAAKzB,MAAzB,EAAiC;AAC7B,iBAAKQ,aAAL,CAAmBR,MAAnB,CAA0BM,IAA1B,CAA+BmB,KAA/B;AACH;;AACD,eAAKjB,aAAL,CAAmBkB,gBAAnB,GArBQ,CAuBR;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACH;;AAEDC,QAAAA,GAAG,GAAE;AAAA;;AACD,cAAG,+BAAKjC,GAAL,CAASkC,kBAAT,CAA4BC,WAA5B,gFAAyCP,IAAzC,8BAAkD,KAAKd,aAAvD,wDAAkD,oBAAoBc,IAAtE,CAAH,EAA8E;AAC1E;AACH;;AACD,eAAK5B,GAAL,CAASkC,kBAAT,CAA4BC,WAA5B,GAA0C,KAAKrB,aAA/C;AACA,eAAKd,GAAL,CAASkC,kBAAT,CAA4BE,IAA5B;AACH;;AArDsB,O","sourcesContent":["/****\n* 1.需要知道animationClip\n* 2.需要具有播放动画能力\n* */\nimport {AnimationClip, Sprite, animation, SpriteFrame } from \"cc\";\nimport ResourceManager from \"db://assets/Runtime/ResourceManager\";\nimport {StateMachine} from \"db://assets/Base/StateMachine\";\nimport {sortSpriteFrame} from \"db://assets/Utils\";\n\nexport const ANIMATION_SPEED = 1/8;\n\nexport default class State {\n    constructor(\n        private fsm: StateMachine,\n        private path: string,\n        private wrapMode: AnimationClip.WrapMode = AnimationClip.WrapMode.Normal,\n        private speed: number = ANIMATION_SPEED,\n        private events: any[] = []\n    ){\n        this.init();\n    }\n    private animationClip: AnimationClip\n\n    async init(){\n        const promise = ResourceManager.Instance.loadDir(this.path);\n        this.fsm.waitingList.push(promise);\n        const spriteFrames = await promise;\n        this.animationClip = new AnimationClip();\n\n        const track = new animation.ObjectTrack(); // 创建一个对象轨道\n        track.path = new animation.TrackPath().toComponent(Sprite).toProperty('spriteFrame'); // 指定轨道路径\n        const frames:Array<[number, SpriteFrame]> = sortSpriteFrame(spriteFrames).map((item, index)=> [this.speed * index, item]);\n        // 为 x 通道的曲线添加关键帧\n        track.channel.curve.assignSorted(frames);\n        // 最后将轨道添加到动画剪辑以应用\n        this.animationClip.addTrack(track);\n        this.animationClip.name = this.path;\n        this.animationClip.duration = frames.length * this.speed; // 整个动画剪辑的周期\n        this.animationClip.wrapMode = this.wrapMode;\n\n        //绑定动画帧事件\n        for (const event of this.events) {\n            this.animationClip.events.push(event);\n        }\n        this.animationClip.updateEventDatas();\n        \n        // const animationComponent = this.node.getComponent(Animation);\n        // if (animationComponent && animationComponent.defaultClip) {\n        //     const { defaultClip } = animationComponent;\n        //     defaultClip.events.push({\n        //         frame: 0.5, // 第 0.5 秒时触发事件\n        //         func: 'onTriggered', // 事件触发时调用的函数名称\n        //         params: [ 0 ], // 向 `func` 传递的参数\n        //     });\n        //     defaultClip.updateEventDatas();\n        // }\n    }\n\n    run(){\n        if(this.fsm.animationComponent.defaultClip?.name === this.animationClip?.name){\n            return;\n        }\n        this.fsm.animationComponent.defaultClip = this.animationClip;\n        this.fsm.animationComponent.play();\n    }\n}"]}